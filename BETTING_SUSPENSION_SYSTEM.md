# 🚫 골 직후 베팅 일시 중지 시스템 (Cool-down Period)

## 🎯 핵심 기능

### 골이 들어가면 → 자동으로 30초간 베팅 중지!

실제 스포츠북 업계 표준을 구현한 **공정한 베팅 시스템**입니다.

---

## 🔥 작동 방식

### 1️⃣ 스코어 변경 감지
```
[30초 전] Man Utd 1-0 Liverpool (베팅 가능 ✅)
[골!] Man Utd 2-0 Liverpool ⚽
[즉시] 스코어 변경 감지 → 베팅 30초 중지 🚫
[30초 후] 자동으로 베팅 재개 ✅
```

### 2️⃣ 타임라인 예시
```
15:23:00 → ⚽ 골!
15:23:30 → 🔄 백엔드 스코어 업데이트 (30초 주기)
         → 🚫 베팅 일시 중지 시작
         → bettingSuspendedUntil = 15:24:00
15:23:35 → 📱 프론트엔드 확인 (5초 폴링)
         → ⚠️ "베팅 일시 중지" 알림 표시
15:24:00 → ✅ 자동 재개
         → bettingSuspendedUntil = null
15:24:05 → 📱 프론트엔드 확인
         → ✅ "베팅하기" 버튼 활성화
```

---

## 💻 구현 내역

### 1️⃣ 데이터베이스
```sql
ALTER TABLE sports_matches 
ADD COLUMN betting_suspended_until DATETIME NULL;
```

### 2️⃣ 백엔드 서비스

#### `BettingSuspensionService`
- ✅ 스코어 변경 감지
- ✅ 30초 베팅 중지
- ✅ 자동 재개 체크

#### 핵심 로직:
```kotlin
// 스코어 변경 시
if (scoreChanged && match.status == "LIVE") {
    match.bettingSuspendedUntil = LocalDateTime.now().plusSeconds(30)
    println("🚫 골! 베팅 30초 중지")
}

// 베팅 시도 시
if (isBettingSuspended(questionId)) {
    return "⚠️ 골 직후 베팅이 일시 중지되었습니다. ${remainingSeconds}초 후 재개됩니다."
}
```

### 3️⃣ API 엔드포인트

#### `POST /api/bet` - 베팅 실행
- ✅ 베팅 전 자동으로 중지 상태 체크
- ✅ 중지 중이면 `403 Forbidden` + 남은 시간 표시

#### `GET /api/betting/suspension/question/{questionId}`
- ✅ 질문 ID로 베팅 중지 상태 확인
- ✅ 남은 시간 (초) 반환

### 4️⃣ 프론트엔드 UI

#### LIVE 대시보드
- ⚠️ **베팅 일시 중지 알림** (노란색 배너)
- ⏳ **남은 시간 카운트다운** (실시간 표시)
- 🚫 **베팅 버튼 비활성화**
- ✅ **30초 후 자동 활성화**

---

## 🎮 사용자 경험

### 골이 들어갔을 때:

#### Before (베팅 중지 없음) ❌
```
[골!] ⚽
[사용자] 즉시 베팅 클릭
[문제] 불공정한 이익 가능
```

#### After (베팅 중지 적용) ✅
```
[골!] ⚽
[30초 이내] 스코어 업데이트
[화면] ⚠️ "골 직후 베팅이 일시 중지되었습니다. 25초 후 재개됩니다."
[버튼] 🚫 "베팅 중지 중..." (비활성화)
[30초 후] ✅ "실시간 베팅하기" (활성화)
```

---

## 📊 시스템 흐름

```
[API-FOOTBALL]
     ↓ (30초마다 폴링)
[백엔드 스케줄러]
     ↓
[스코어 변경 감지]
     ↓
[이전 스코어 != 현재 스코어]
     ↓
[🚫 베팅 일시 중지 30초]
     ↓
[DB 저장: bettingSuspendedUntil]
     ↓
[프론트엔드 5초 폴링]
     ↓
[⚠️ 중지 알림 표시]
     ↓
[베팅 시도 시]
     ↓
[403 Forbidden + 남은 시간]
     ↓
[30초 경과]
     ↓
[✅ 자동 재개]
```

---

## 🧪 테스트 시나리오

### 1. 정상 베팅
```bash
curl -X POST "http://localhost:8080/api/bet" \
  -H "Content-Type: application/json" \
  -d '{
    "memberId": 1,
    "questionId": 6,
    "choice": "YES",
    "amount": 1000
  }'

# 응답: {"success": true}
```

### 2. 골 직후 베팅 시도 (중지 중)
```bash
# 같은 요청
# 응답: 
{
  "success": false,
  "message": "⚠️ 골 직후 베팅이 일시 중지되었습니다. 25초 후 재개됩니다."
}
```

### 3. 중지 상태 확인
```bash
curl "http://localhost:8080/api/betting/suspension/question/6"

# 응답:
{
  "suspended": true,
  "resumeAt": "2026-01-31T15:35:30",
  "remainingSeconds": 25
}
```

### 4. 30초 후 재시도
```bash
# 베팅 재시도
# 응답: {"success": true} ✅
```

---

## ⚙️ 설정 옵션

### 중지 시간 변경
```kotlin
// BettingSuspensionService.kt
match.bettingSuspendedUntil = LocalDateTime.now().plusSeconds(30)
                                                    // ↑ 여기를 변경
// 예: 60초로 변경하려면 plusSeconds(60)
```

### 특정 질문만 중지 (필터링)
```kotlin
// 스포츠 질문만 베팅 중지
if (scoreChanged && match.status == "LIVE" && match.category == "SPORTS") {
    // 중지 로직
}
```

---

## 🎯 장점

### 1️⃣ 공정성
- ✅ 골 직후 배당률 급변 악용 방지
- ✅ 모든 사용자에게 동일한 기회

### 2️⃣ 시스템 안정성
- ✅ 스코어 업데이트 완전 반영 시간 확보
- ✅ 배당률 재계산 시간 확보

### 3️⃣ 업계 표준
- ✅ Bet365, Polymarket 등 실제 스포츠북 방식
- ✅ 신뢰할 수 있는 플랫폼 이미지

### 4️⃣ 자동화
- ✅ 수동 개입 불필요
- ✅ 30초 후 자동 재개
- ✅ 남은 시간 실시간 표시

---

## 📱 프론트엔드 UI

### LIVE 경기 대시보드

#### 정상 상태 (베팅 가능)
```
┌─────────────────────────────────┐
│ 🔴 LIVE | EPL                   │
├─────────────────────────────────┤
│ Manchester United    2           │
│                    -             │
│ Liverpool           1            │
├─────────────────────────────────┤
│ [🎯 실시간 베팅하기]             │
└─────────────────────────────────┘
```

#### 베팅 중지 상태
```
┌─────────────────────────────────┐
│ 🔴 LIVE | EPL                   │
├─────────────────────────────────┤
│ ⚠️ 베팅 일시 중지                │
│ 골 직후 30초간 베팅이 중지됩니다  │
│ 25초 후 재개                25s  │
├─────────────────────────────────┤
│ Manchester United    2           │
│                    -             │
│ Liverpool           1            │
├─────────────────────────────────┤
│ [⏳ 베팅 중지 중...] (비활성화)  │
└─────────────────────────────────┘
```

---

## 🎉 완료!

### ✅ 구현 완료:
- ✅ 스코어 변경 자동 감지
- ✅ 30초 베팅 일시 중지
- ✅ 자동 재개
- ✅ 남은 시간 표시
- ✅ 프론트엔드 UI
- ✅ API 엔드포인트

### 🚀 결과:
**골이 들어가면 자동으로 30초간 베팅이 중지되고, 30초 후 자동으로 재개됩니다!**

---

**이제 공정하고 안정적인 실시간 스포츠 베팅 시스템이 완성되었습니다!** ⚽🚫⏳✅
